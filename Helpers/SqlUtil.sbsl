#required IO.sbsl

@Global
method CreateDatabaseFromLastBackup(
    Server: String,
    Database: String,
    User: String,
    Password: String,
    NewDatabaseName: String)
    use connection = BuildConnection(Server, Database, User, Password)

    val databaseFiles = GetDatabaseFileNames(connection, Database)
    val fullBackup = GetLastFullBackup(connection, Database)

    RestoreBackup(connection, databaseFiles, fullBackup, NewDatabaseName)
;

method GetLastFullBackup(Connection: SqlConnection, Database: String): FullBackup
    val query = Connection.CreateQueryWithSelect(
        "SELECT  
        A.[Server],
        A.database_name,
        A.last_db_backup_date,  
        B.backup_start_date,  
        B.expiration_date, 
        B.backup_size,  
        B.logical_device_name,  
        B.physical_device_name,   
        B.backupset_name, 
        B.description 
        FROM 
        ( 
        SELECT   
            CONVERT(CHAR(100), SERVERPROPERTY('Servername')) AS Server, 
            msdb.dbo.backupset.database_name,  
            MAX(msdb.dbo.backupset.backup_finish_date) AS last_db_backup_date 
        FROM 
            msdb.dbo.backupmediafamily  
            INNER JOIN msdb.dbo.backupset ON msdb.dbo.backupmediafamily.media_set_id = msdb.dbo.backupset.media_set_id  
        WHERE 
            msdb..backupset.type = 'D' 
        GROUP BY 
            msdb.dbo.backupset.database_name  
        ) AS A 
        LEFT JOIN  
        ( 
        SELECT   
            CONVERT(CHAR(100), SERVERPROPERTY('Servername')) AS Server, 
            msdb.dbo.backupset.database_name,  
            msdb.dbo.backupset.backup_start_date,  
            msdb.dbo.backupset.backup_finish_date, 
            msdb.dbo.backupset.expiration_date, 
            msdb.dbo.backupset.backup_size,  
            msdb.dbo.backupmediafamily.logical_device_name,  
            msdb.dbo.backupmediafamily.physical_device_name,   
            msdb.dbo.backupset.name AS backupset_name, 
            msdb.dbo.backupset.description 
        FROM 
            msdb.dbo.backupmediafamily  
            INNER JOIN msdb.dbo.backupset ON msdb.dbo.backupmediafamily.media_set_id = msdb.dbo.backupset.media_set_id  
        WHERE 
            msdb..backupset.type = 'D' 
        ) AS B 
        ON A.[server] = B.[server] AND A.[database_name] = B.[database_name] AND A.[last_db_backup_date] = B.[backup_finish_date]
        WHERE
            A.database_name = '${Database}'
        ORDER BY  
        A.database_name")

    use qResult = query.Execute()
    qResult.Next()

    return new FullBackup(
        qResult.Get("physical_device_name").ToString()
    )
;

method GetDatabaseFileNames(Connection: SqlConnection, Database: String): DatabaseFiles
    val query = Connection.CreateQueryWithSelect(
        "Select 
            d.name as DatabaseName,
            L.name as LogFileName,
            R.name as DataFileName,
            R.physical_name as DataFilePath,
            L.physical_name as LogFilePath
        FROM
            sys.databases AS D
            INNER JOIN sys.master_files AS L ON 
                D.database_id = L.database_id AND
                L.type_desc = 'LOG'
            INNER JOIN sys.master_files AS R ON
                D.database_id = R.database_id AND
                R.type_desc = 'ROWS'
        WHERE
            LEFT(L.physical_name, 1) = LEFT(R.physical_name, 1)
            AND D.name = '${Database}'
        ORDER BY
            D.name"
    )

    use qResult = query.Execute()
    qResult.Next()

    return new DatabaseFiles(
        qResult.Get("DataFileName").ToString(),
        qResult.Get("DataFilePath").ToString(),
        qResult.Get("LogFileName").ToString(),
        qResult.Get("LogFilePath").ToString()
    )
;

method RestoreBackup(Connection: SqlConnection, DatabaseFiles: DatabaseFiles, FullBackup: FullBackup, NewDatabaseName: String)
    val defaultLocations = GetDatabaseDefaultLocations(Connection)
    val mdfPath = IO.JoinPath(defaultLocations.Data, "${NewDatabaseName}.mdf")
    val logPath = IO.JoinPath(defaultLocations.Log, "${NewDatabaseName}_log.ldf")
    
    val query = Connection.CreateQueryWithoutSelect(
        "RESTORE DATABASE [${NewDatabaseName}] FROM  DISK = N'${FullBackup.Path}' 
        WITH MOVE N'${DatabaseFiles.DataFileName}' TO N'${mdfPath}',  
            MOVE N'${DatabaseFiles.LogFileName}' TO N'${logPath}',
        REPLACE;")

    query.Execute()
;

method GetDatabaseDefaultLocations(Connection: SqlConnection): DefaultDatabaseFilesLocation
    val result = GetDatabaseFileNames(Connection, "master")

    return new DefaultDatabaseFilesLocation(
        IO.GetParentDirectory(result.DataFilePath), 
        IO.GetParentDirectory(result.LogFilePath))    
;

method BuildConnection(
    Server: String,
    Database: String,
    User: String,
    Password: String): SqlConnection
    return new SqlConnection("jdbc:sqlserver://${Server};encrypt=false;databaseName=${Database};user=${User};password=${Password};")
;

structure DatabaseFiles
    val DataFileName: String
    val DataFilePath: String
    val LogFileName: String
    val LogFilePath: String
;

structure FullBackup
    val Path: String
;

structure DefaultDatabaseFilesLocation
    val Data: String
    val Log: String
;